<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sounny's WebPlotDigitizer</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="widgets.css">
  <link rel="shortcut icon" href="favicon.ico">
  
  <!-- Third-party dependencies: PDF.js (for PDF import) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-+xZ9rC1NqAMlQ1S8h1C6qBf4krtCw4z69mZz0F0G9PjK+NQFduW6xYh2fYt2u+v7u8vWPGKqXh8aBkH8uy7pwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Configure worker for PDF.js when available
    if (window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    // Simple tarball fallback (project resume via .tar will be disabled gracefully)
    window.tarball = window.tarball || {
      extract: function() { 
        return Promise.reject(new Error('Tarball.js not available')); 
      }
    };
  </script>
</head>
<body>
  <div id="loadingCurtain" style="position:absolute;top:0;left:0;width:100%;height:100%;background-color:white;z-index:100;display:flex;justify-content:center;align-items:center;">
    Loading application, please wait...
  </div>

  <div id="allContainer">
    <!-- toolbar + graphics -->
    <div id="mainContainer">
      <div id="topContainer">
        <div id="menuButtonsContainer">
          <div id="navbar">
            <span class="brand">Sounny’s WPD</span>
            <label for="fileLoadBox">Load image/PDF:</label>
            <input class="btn" type="file" id="fileLoadBox" accept="image/*,application/pdf" onchange="wpd.imageManager.load()" />
            <select id="sample-select" class="btn" title="Choose a sample image">
              <option value="start.png">Sample: Getting Started</option>
              <option value="images/xyaxes.png">Sample: XY Axes</option>
              <option value="images/polaraxes.png">Sample: Polar Axes</option>
              <option value="images/ternaryaxes.png">Sample: Ternary Axes</option>
              <option value="images/map.png">Sample: Map</option>
              <option value="images/barchart.png">Sample: Bar Chart</option>
            </select>
            <button class="btn btn-primary" type="button" onclick="window._wpdLoadSample()">Load sample</button>
            <button class="btn" type="button" onclick="wpd.dataExport.generateCSV()">Export CSV</button>
            <button class="btn btn-ghost" type="button" onclick="wpd.sidebar.show('help-sidebar')">Help</button>
            <span id="navSeparator" style="margin:0 8px;">|</span>
            <div class="files" style="display:none;">
              <label for="image-file-select">File:</label>
              <select id="image-file-select" onchange="wpd.appData.getFileManager().switch(this.value)"></select>
            </div>
            <div class="paged" style="display:none; align-items:center; gap:6px;">
              <label for="image-page-nav-select">Page:</label>
              <select id="image-page-nav-select" onchange="wpd.appData.getPageManager()?.switch(this.value)"></select>
              <button type="button" title="Relabel pages" onclick="wpd.popup.show('image-page-relabel-popup')">Relabel…</button>
            </div>
          </div>
        </div>
        <div id="topToolbarContainer">
          <div style="position:relative;"></div>
        </div>
        <div style="display: inline-flex; gap: 6px; position: absolute; top: 12px; right: 310px;">
          <button class="btn" type="button" title="Rotate 90° counter-clockwise" onclick="wpd.graphicsWidget.rotateCounterClockwise();">↺</button>
          <button class="btn" type="button" title="Rotate 90° clockwise" onclick="wpd.graphicsWidget.rotateClockwise();">↻</button>
          <button class="btn" type="button" title="Zoom in" onclick="wpd.graphicsWidget.zoomIn();">+</button>
          <button class="btn" type="button" title="Zoom out" onclick="wpd.graphicsWidget.zoomOut();">-</button>
          <button class="btn" type="button" title="View actual size" onclick="wpd.graphicsWidget.zoom100perc();">100%</button>
          <button class="btn" type="button" title="Fit to graphics area" onclick="wpd.graphicsWidget.zoomFit();">Fit</button>
          <button class="btn" title="Toggle extended crosshair" onclick="wpd.graphicsWidget.toggleExtendedCrosshairBtn();" id="extended-crosshair-btn" style="width:32px; background-image: url('images/crosshair.svg'); background-repeat: no-repeat; background-position: center; background-size: 18px;">&nbsp;</button>
        </div>
      </div>

      <div style="display: flex;">
        <div id="left-side-container" style="width:200px; flex: 0 0 169px;">
          <!-- tree control -->
          <div id="tree-container" class="tree-container" tabindex="0" aria-label="Project Tree"></div>
        </div>

        <div id="graphicsContainer" style="flex: 1;">
          <!-- the main canvas goes here -->
          <div id="canvasDiv" style="position:relative;">
            <canvas id="mainCanvas" class="canvasLayers" style="z-index:1;"></canvas>
            <canvas id="dataCanvas" class="canvasLayers" style="z-index:2;"></canvas>
            <canvas id="drawCanvas" class="canvasLayers" style="z-index:3;"></canvas>
            <canvas id="hoverCanvas" class="canvasLayers" style="z-index:4;"></canvas>
            <canvas id="topCanvas" class="canvasLayers" style="z-index:5;"></canvas>
          </div>
        </div>
      </div>

      <div id="bottomContainer">
        <div id="bottomNavbarContainer"></div>
      </div>
    </div>

    <!-- sidebar + zoom -->
    <div id="sidebarContainer">
      <!-- zoom window goes here -->
      <div style="position:relative;" id="zoomDiv">
        <canvas id="zoomCanvas" class="zoomLayers" width=250 height=250 style="position:relative; top: 0px; left: 0px; z-index:1;"></canvas>
        <canvas id="zoomCrossHair" class="zoomLayers" width=250 height=250 style="position:absolute; top: 0px; left: 0px; z-index:2; background:transparent;"></canvas>
        <div id="cursorPosition" style="position:relative;">
          [<span id="mousePosition"></span>]
        </div>
      </div>

      <div id="zoom-settings-container"><input type="button" id="zoom-settings-button" title="Change zoom settings" value="&#9881;" onclick="wpd.zoomView.showSettingsWindow();" /></div>

      <div style="position:relative;" id="sidebarControlsContainer">
        <!-- Minimal sidebars -->
        <div id="start-sidebar" class="sidebar" style="display:none; padding:8px;">
          <h3>Start</h3>
          <p>Use the file input above to load an image or PDF, or pick a sample from the dropdown.</p>
          <ol>
            <li>Load an image/PDF.</li>
            <li>Select Image, Axes, Datasets, or Measurements from the left tree.</li>
            <li>Calibrate axes, then digitize data points.</li>
            <li>Export data when done.</li>
          </ol>
        </div>
        <div id="image-editing-sidebar" class="sidebar" style="display:none; padding:8px;">
          <h3>Image</h3>
          <p>Rotate or zoom using the controls above. Additional tools will appear as needed.</p>
        </div>
        <div id="help-sidebar" class="sidebar" style="display:none; padding:8px;">
          <h3>Help</h3>
          <ol>
            <li>Load an image or PDF (or choose a sample) from the top bar.</li>
            <li>Use the left tree to switch between Image, Axes, Datasets, and Measurements.</li>
            <li>Calibrate axes first, then select a dataset and a detection method.</li>
            <li>The zoom pane on the right helps with precise clicks.</li>
            <li>For multi-page PDFs, use the Page selector in the top bar.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Basic translation strings -->
  <div style="display:none;" id="translation-strings">
    <span id="i18n-string-image">Image</span>
    <span id="i18n-string-axes">Axes</span>
    <span id="i18n-string-datasets">Datasets</span>
    <span id="i18n-string-measurements">Measurements</span>
    <span id="i18n-string-distance">Distance</span>
    <span id="i18n-string-angle">Angle</span>
    <span id="i18n-string-area">Area</span>
    <span id="i18n-string-invalid-project">Invalid project</span>
    <span id="i18n-string-loading">Loading application, please wait...</span>
    <span id="i18n-string-fit">Fit</span>
    <span id="i18n-string-processing">Processing</span>
    <span id="i18n-string-ok">OK</span>
    <span id="i18n-string-cancel">Cancel</span>
    <span id="i18n-string-unsupported">Unsupported</span>
    <span id="i18n-string-unsupported-text">This feature is not supported in this build.</span>
    <span id="i18n-string-invalid-file">Invalid file</span>
    <span id="i18n-string-invalid-file-text">Please select an image or a PDF file.</span>
  </div>

  <!-- Popups and modal infrastructure -->
  <div id="shadow" style="visibility:hidden;"></div>
  <div id="messagePopup" class="popupwindow" style="visibility:hidden; position:absolute;">
    <div class="popupheading">
      <span id="message-popup-heading">Message</span>
      <input type="button" value="×" title="Close" onclick="wpd.messagePopup.close()" style="float:right;">
    </div>
    <div class="popupcontent">
      <p id="message-popup-text"></p>
      <div style="text-align:right;">
        <input type="button" value="Close" onclick="wpd.messagePopup.close()">
      </div>
    </div>
  </div>
  <div id="okCancelPopup" class="popupwindow" style="visibility:hidden; position:absolute;">
    <div class="popupheading">
      <span id="ok-cancel-popup-heading">Confirm</span>
      <input type="button" value="×" title="Close" onclick="wpd.okCancelPopup.cancel()" style="float:right;">
    </div>
    <div class="popupcontent">
      <p id="ok-cancel-popup-text"></p>
      <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <input id="ok-cancel-popup-ok-button" type="button" value="OK" onclick="wpd.okCancelPopup.ok()">
        <input id="ok-cancel-popup-cancel-button" type="button" value="Cancel" onclick="wpd.okCancelPopup.cancel()">
      </div>
    </div>
  </div>
  <!-- Minimal stub for legacy popups referenced in controllers -->
  <div id="loadNewImage" class="popupwindow" style="visibility:hidden; position:absolute;">
    <div class="popupheading">
      <span>Load Image</span>
      <input type="button" value="×" title="Close" onclick="wpd.popup.close('loadNewImage')" style="float:right;">
    </div>
    <div class="popupcontent">
      <p>Use the file input in the top bar to select an image or PDF.</p>
    </div>
  </div>
  <div id="axesList" class="popupwindow" style="visibility:hidden; position:absolute;">
    <div class="popupheading">
      <span>Axes</span>
      <input type="button" value="×" title="Close" onclick="wpd.popup.close('axesList')" style="float:right;">
    </div>
    <div class="popupcontent">
      <p>After loading, choose an axes type from the sidebars to begin calibration.</p>
    </div>
  </div>
  <div id="image-page-relabel-popup" class="popupwindow" style="visibility:hidden; position:absolute;">
    <div class="popupheading">
      <span>Relabel pages</span>
      <input type="button" value="×" title="Close" onclick="wpd.popup.close('image-page-relabel-popup')" style="float:right;">
    </div>
    <div class="popupcontent">
      <div style="display:flex; gap:8px; align-items:center;">
        <label for="image-page-relabel-input">New label:</label>
        <input id="image-page-relabel-input" oninput="wpd.appData.getPageManager()?.validateLabel(this.value)">
      </div>
      <div style="margin-top:8px;">
        <label><input type="checkbox" id="image-page-relabel-all-checkbox" disabled> Apply relative labels to all pages</label>
      </div>
      <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
        <input id="image-page-relabel-set-button" type="button" value="Set" disabled onclick="wpd.appData.getPageManager()?.setLabel()">
        <input id="image-page-relabel-delete-button" type="button" value="Delete" disabled onclick="wpd.appData.getPageManager()?.deleteLabel(false)">
        <input id="image-page-relabel-delete-all-button" type="button" value="Delete all" disabled onclick="wpd.appData.getPageManager()?.deleteLabel(true)">
      </div>
    </div>
  </div>

  <!-- Individual, uncompressed javascript files -->
  <script src="javascript/controllers/appData.js"></script>
  <script src="javascript/controllers/autoDetection.js"></script>
  <script src="javascript/controllers/axesCalibration.js"></script>
  <script src="javascript/controllers/browserInfo.js"></script>
  <script src="javascript/controllers/colorPicker.js"></script>
  <script src="javascript/controllers/datasetManagement.js"></script>
  <script src="javascript/controllers/fileManager.js"></script>
  <script src="javascript/controllers/gridDetection.js"></script>
  <script src="javascript/controllers/i18n.js"></script>
  <script src="javascript/controllers/imageEditing.js"></script>
  <script src="javascript/controllers/imageManager.js"></script>
  <script src="javascript/controllers/manualDetection.js"></script>
  <script src="javascript/controllers/measurements.js"></script>
  <script src="javascript/controllers/pageManager.js"></script>
  <script src="javascript/controllers/undoManager.js"></script>
  <script src="javascript/controllers/utils.js"></script>
  <script src="javascript/core/autoDetection.js"></script>
  <script src="javascript/core/axes/bar.js"></script>
  <script src="javascript/core/axes/circularChartRecorder.js"></script>
  <script src="javascript/core/axes/image.js"></script>
  <script src="javascript/core/axes/map.js"></script>
  <script src="javascript/core/axes/polar.js"></script>
  <script src="javascript/core/axes/ternary.js"></script>
  <script src="javascript/core/axes/xy.js"></script>
  <script src="javascript/core/calibration.js"></script>
  <script src="javascript/core/color.js"></script>
  <script src="javascript/core/colorAnalysis.js"></script>
  <script src="javascript/core/connectedPoints.js"></script>
  <script src="javascript/core/curve_detection/averagingWindow.js"></script>
  <script src="javascript/core/curve_detection/averagingWindowCore.js"></script>
  <script src="javascript/core/curve_detection/averagingWindowWithStepSize.js"></script>
  <script src="javascript/core/curve_detection/barExtraction.js"></script>
  <script src="javascript/core/curve_detection/blobdetector.js"></script>
  <script src="javascript/core/curve_detection/customIndependents.js"></script>
  <script src="javascript/core/curve_detection/xStepWithInterpolation.js"></script>
  <script src="javascript/core/dataProviders.js"></script>
  <script src="javascript/core/dataset.js"></script>
  <script src="javascript/core/dateConversion.js"></script>
  <script src="javascript/core/gridDetectionCore.js"></script>
  <script src="javascript/core/inputParser.js"></script>
  <script src="javascript/core/mathFunctions.js"></script>
  <script src="javascript/core/plotData.js"></script>
  <script src="javascript/core/point_detection/template_matching_detector.js"></script>
  <script src="javascript/core/rle.js"></script>
  <script src="javascript/services/args.js"></script>
  <script src="javascript/services/dataExport.js"></script>
  <script src="javascript/services/download.js"></script>
  <script src="javascript/services/events.js"></script>
  <script src="javascript/services/log.js"></script>
  <script src="javascript/services/plotly.js"></script>
  <script src="javascript/services/saveResume.js"></script>
  <script src="javascript/services/scriptInjection.js"></script>
  <script src="javascript/tools/axesCalibrationTools.js"></script>
  <script src="javascript/tools/colorPickerTools.js"></script>
  <script src="javascript/tools/graphicsHelper.js"></script>
  <script src="javascript/tools/gridDetectionTools.js"></script>
  <script src="javascript/tools/imageEditingTools.js"></script>
  <script src="javascript/tools/imageOps.js"></script>
  <script src="javascript/tools/keyCodes.js"></script>
  <script src="javascript/tools/manualDetectionTools.js"></script>
  <script src="javascript/tools/maskTools.js"></script>
  <script src="javascript/tools/measurementTools.js"></script>
  <script src="javascript/widgets/dataTable.js"></script>
  <script src="javascript/widgets/graphicsWidget.js"></script>
  <script src="javascript/widgets/layoutManager.js"></script>
  <script src="javascript/widgets/pointGroups.js"></script>
  <script src="javascript/widgets/popups.js"></script>
  <script src="javascript/widgets/sidebars.js"></script>
  <script src="javascript/widgets/toolbars.js"></script>
  <script src="javascript/widgets/tree.js"></script>
  <script src="javascript/widgets/webcam.js"></script>
  <script src="javascript/widgets/zoom.js"></script>

  <!-- Core application script -->
  <script src="javascript/main.js"></script>
  <!-- Initialization is handled by javascript/main.js (wpd.initApp). Add a tiny helper for samples. -->
  <script>
    window._wpdLoadSample = function() {
      try {
        const sel = document.getElementById('sample-select');
        const url = sel ? sel.value : 'start.png';
        // Use existing API to load by URL
        if (wpd && wpd.imageManager && wpd.imageManager.loadFromURL) {
          wpd.busyNote && wpd.busyNote.show && wpd.busyNote.show();
          wpd.imageManager.loadFromURL(url).then(() => {
            wpd.busyNote && wpd.busyNote.close && wpd.busyNote.close();
          }).catch(err => {
            wpd.busyNote && wpd.busyNote.close && wpd.busyNote.close();
            console.error('Sample load error:', err);
            wpd.messagePopup && wpd.messagePopup.show && wpd.messagePopup.show('Error', 'Could not load sample: ' + err.message);
          });
        } else if (wpd && wpd.loadDefaultImage) {
          wpd.loadDefaultImage();
        }
      } catch (e) {
        console.error(e);
      }
    };
  </script>
</body>
</html>
